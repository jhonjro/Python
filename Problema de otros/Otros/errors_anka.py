# -*- coding: utf-8 -*-
"""
Created on Fri Aug  6 17:08:25 2021

@author: jhon_
"""


import os
import pandas as pd
import numpy as np

lima = {'9779': 1, '11247': 1, '103401': 1, '103919': 1, '103920': 1, '104223': 1, '104218': 1, '104219': 1, '104224': 1, '104226': 1, '104271': 1, '104100': 1, '104220': 1, '103697': 1, '10868': 1, '102405': 1, '100291': 1, '104351': 1, '104350': 1, '103773': 1, '103774': 1, '103056': 1, '104126': 1, '104244': 1, '104242': 1, '101775': 1, '103380': 1, '104343': 1, '104167': 1, '103374': 1, '104363': 1, '103209': 1, '101993':
        17, '11361': 1, '102502': 1, '103743': 1, '103746': 1, '102743': 2, '9999': 1, '101365': 1, '104053': 1, '104200': 5, '102986': 10, '104332': 33, '104353': 10, '103547': 7, '102855': 2, '103635': 4, '103916': 11, '100620': 2, '100467': 5, '103161': 3, '7259': 1, '12222': 70, '104427': 10, '104057': 3, '103418': 15, '104058': 1, '103533': 9, '104070': 4, '8477': 3, '102818': 59, '100897': 8, '102763': 5, '102628': 14, '101892': 3, '101340': 8, '103023': 2, '103600': 2, '101281': 2, '102919': 8, '103280': 5, '103828': 2, '102953': 1, '103325': 1, '104437': 34, '104436': 20, '103675': 2, '104311': 2, '103521': 5, '102267': 6, '103478': 12, '103477': 40, '102363': 32, '104337': 1, '103566': 10, '104336': 2, '100452': 12, '103882': 11, '103006': 28, '104358': 3, '103953': 6, '104428': 50, '102751': 19, '104359': 2, '103807': 23, '100416': 1, '104357': 3, '104356': 1, '104355': 3, '104272': 30, '104308': 1, '104309': 1, '104213': 2, '102463': 2,
        '103558': 1, '103617': 4, '103903': 2, '103904': 3, '103905': 1, '12498': 7, '104198': 2, '103352': 88, '103356': 10, '103354': 2, '103355': 1, '103912': 1, '104261': 5, '104306': 8, '104278': 8, '103810': 1, '104367': 39, '102985': 1, '104307': 27, '104438': 50, '104090': 2, '104119': 52, '104210': 4, '103814': 76,
        '103816': 3, '104089': 9, '103581': 10, '104390': 10, '104361': 2, '104157': 1, '102995': 9, '103101': 7,
        '102644': 7, '103036': 4, '103504': 36, '104364': 3, '104434': 200, '104091': 3, '103861': 2, '102899': 4, '102076': 1, '102077': 1, '102081': 3, '101863': 1, '101595': 9, '12439': 9, '103422': 17, '103421': 2, '102840': 49, '102841': 4, '103761': 5, '104398': 1, '104326': 1, '104397': 1, '104396': 1, '103699': 1, '102788': 1, '10657': 1, '7434': 1, '100207': 1, '100209': 1, '6884': 1, '6903': 1, '6901': 1, '6915': 1, '6913': 1, '6914': 1, '12090': 1, '8542': 1, '103264': 1, '103261': 1, '103739': 1, '103740': 1, '103436': 1, '103435': 1, '6696': 1, '6697': 1, '8559': 1, '8560': 1, '8561': 1, '7253': 1, '7124': 1, '6891': 1, '10535': 1, '10530': 1, '10531': 1, '9038': 1, '9039': 1, '9035': 1, '102681': 1, '102693': 1, '102694': 1, '103854': 1, '100879': 1, '100880': 1, '100881': 1, '10074': 1, '103414': 1, '7876': 1, '9155': 1, '103568': 1, '11014': 1, '104080': 6, '103665': 1, '103849': 2, '104124': 7, '104125': 2, '104352': 1, '103365': 5, '103364': 12, '103362': 21, '103331': 25, '103189': 6, '103244': 1, '103363': 4, '103564': 10, '104424': 20, '104197': 9, '104251': 2, '104381': 4, '9532': 1, '7793': 4, '103132': 2, '104426': 30, '104425': 10, '103662': 1, '104036': 3, '103898': 2, '104035': 3, '102270': 5, '8275': 5, '104295': 1, '104296': 1, '104429': 1, '103543': 1, '103544': 1, '104368': 1, '104369': 1}

huancayo = {'9394': 1, '102152': 1, '102153': 1, '101720': 1, '102155': 1, '101721': 1, '101726': 1, '101727': 1, '9669': 1, '9670': 1, '9668': 1, '9667': 1, '9663': 1, '9664': 1, '9665': 1, '9666': 1, '9411': 1, '102000': 1, '102001': 1, '102002': 1, '102003': 1, '101729': 1, '101728': 1, '101700': 1, '100634': 1, '100628': 1, '100701': 1, '101597': 1, '6829': 1, '10542': 1, '9779': 1, '6856': 1, '11380': 1, '12328': 1, '9055': 1, '8201': 1, '7308': 1, '11247': 1, '102874': 1, '102015': 1, '103401': 1, '6271': 1, '103919': 1, '103920': 1, '104218': 1, '104224': 1, '100553': 1, '10690': 1, '7191': 1, '9748': 1, '104271': 1, '104100': 1, '103235': 1, '9474': 1, '11823': 1, '104150': 1, '104148': 1, '104155': 1, '104154': 1, '104153': 1, '104220': 1, '7275': 1, '7408': 1, '10541': 1, '10868': 1, '6662': 1, '102824': 1, '7825': 1, '7877': 1, '8495': 1, '101804': 1, '102405': 1, '8271': 1, '12009': 1, '7343': 1, '101889': 1, '100291': 1, '8490': 1, '8236': 1, '11203': 1, '10519': 1, '9045': 1, '9052': 1, '9396': 1, '9395': 1, '8602': 1, '8601': 1, '8876': 1, '104351': 1, '101390': 1, '11907': 8, '102964': 1, '6830': 1, '103592': 1, '102974': 3, '103482': 2, '102647': 1, '12141': 1, '104163': 1, '8741': 1, '103773': 1, '103774': 1, '103392': 1, '103391': 1, '103056': 1, '103393': 1, '104156': 1, '103454': 1, '103455': 1, '100073': 1, '104170': 1, '104168': 1, '104169': 1, '104242': 1, '103389': 1, '101775': 1, '103380': 1, '103381': 1, '103379': 1, '103384': 1, '103378': 1,
            '104343': 1, '104341': 1, '104342': 1, '104340': 1, '11332': 1, '104441': 1, '104440': 1, '104166': 1, '104167': 1, '103374': 1, '104162': 1, '104363': 1, '102315': 1, '103162': 1, '103397': 1, '103398': 1, '103553': 1, '101993': 15, '102558': 1, '11361': 1, '103746': 1, '103745': 1, '102743': 3, '9999': 5, '100825': 2, '101809': 1, '101888': 1, '12382': 1, '104053': 24, '104200': 9, '102986': 33, '104353': 40, '104431': 20, '103547': 7, '102855': 1, '103916': 1, '100620': 9, '100467': 10, '103161': 7, '103514': 1, '103525': 10, '12222': 280, '104427': 10, '104057': 7, '103418': 15, '104058': 2, '103533': 5, '104070': 14, '102818': 4, '100897': 10, '102162': 1, '102763': 3, '102628': 16, '104028': 2, '12183': 1, '101892': 2, '101340': 16, '103113': 1, '103600': 16, '101281': 64, '102919': 5, '103280': 4, '103828': 3, '104437': 36, '104436': 12, '10986': 1, '11847': 2, '9853': 2, '104354': 2, '10271': 1, '103054': 5, '103675': 17, '104430':
            20, '103676': 6, '104311': 2, '103061': 1, '104328': 1, '101914': 1, '104312': 12, '103521': 5, '102267':
            8, '103478': 20, '103477': 26, '103760': 1, '102363': 8, '104337': 59, '104339': 20, '104338': 25, '103358': 3, '103216': 45, '104336': 34, '104171': 1, '104172': 1, '104173': 1, '104174': 1, '100452': 6, '103882': 2, '103006': 71, '104358': 6, '103953': 3, '104428': 200, '102751': 11, '104359': 97, '104362': 95, '103918': 3, '100416': 2, '104357': 36, '104356': 46, '104355': 47, '104272': 216, '104308': 1, '104309': 1,
            '104213': 3, '102463': 5, '103558': 1, '103617': 6, '103904': 2, '103905': 6, '12498': 23, '104198': 27, '103352': 237, '103356': 3, '103354': 26, '103355': 5, '101153': 10, '104261': 5, '104306': 30, '104278': 6, '104367': 24, '102985': 4, '104307': 15, '104438': 50, '104090': 3, '104119': 11, '104210': 149, '103814': 47, '103816': 2, '104089': 10, '104284': 1, '104277': 2, '103581': 20, '104390': 24, '11644': 1, '103472': 1, '103473': 1, '104165': 1, '103735': 1, '103016': 1, '103584': 2, '104433': 1, '104158': 1, '104159': 1, '104147': 1, '104145': 1, '103652': 1, '103650': 1, '102995': 1, '102644': 19, '103504': 95, '104434': 50, '104091': 2, '103943': 1, '10022': 1, '104081': 39, '104082': 46, '103861': 8, '12485': 1, '103251': 1, '104335': 2, '104334': 5, '102899': 2, '102076': 2, '102067': 1, '9561': 1, '100962': 1, '100740': 2,
            '6623': 8, '101595': 8, '12439': 2, '10643': 1, '7003': 1, '104393': 1, '103422': 52, '100009': 1, '10801': 1, '8300': 3, '10684': 1, '104423': 3, '103421': 2, '6488': 1, '10839': 1, '102840': 48, '102841': 16, '102627': 1, '9726': 1, '6545': 1, '103761': 15, '104326': 1, '104397': 1, '104396': 1, '9585': 1, '102788': 1, '7084': 1, '10657': 1, '9254': 1, '9255': 1, '9256': 1, '7434': 1, '11322': 1, '10983': 1, '100207':
            1, '100209': 1, '6883': 1, '6884': 1, '6903': 1, '6901': 1, '8314': 1, '6915': 1, '6914': 1, '12090': 1, '8542': 1, '102833': 1, '103264': 1, '103261': 1, '103739': 1, '103740': 1, '103436': 1, '103435': 1, '6696': 1, '6697': 1, '8558': 1, '8559': 1, '8560': 1, '8561': 1, '103465': 1, '103466': 1, '103467': 1, '103468': 1, '103526': 1, '104032': 1, '102019': 1, '6899': 1, '7253': 1, '7124': 1, '6897': 1, '6898': 1, '6891': 1, '9084': 1, '11515': 1, '7072': 1, '10535': 1, '10529': 1, '10530': 1, '10531': 1, '8516': 1, '6991': 1, '6992': 1, '9038': 1, '9039': 1, '9035': 1, '102681': 1, '102693': 1, '102694': 1, '103854': 1, '100879': 1, '100880': 1, '100881': 1, '7381': 1, '10074': 1, '103414': 1, '8110': 1, '8111': 1, '6923': 1, '8978': 1, '8980': 1, '6928': 1, '100473': 1, '100475': 1, '100474': 1, '100297': 1, '9793': 1, '10824': 1, '10825': 1, '10826': 1, '6925': 1, '6926': 1, '11193': 1, '11194': 1, '11651': 1, '7900': 1, '8566': 1, '11131': 1, '7499': 1, '7338': 1, '8322': 1, '8780': 1, '9155': 1, '12105': 1, '11678': 1, '8311': 1, '6931':
            1, '103568': 1, '11139': 1, '11650': 1, '12492': 1, '10124': 1, '11957': 1, '103039': 1, '103949': 1, '11468': 1, '103108': 1, '11253': 1, '12194': 1, '11014': 1, '10743': 1, '6962': 1, '6963': 1, '6965': 1, '10227': 1, '6941': 1, '11592': 1, '11083': 1, '10405': 1, '6956': 1, '6957': 1, '6958': 1, '6959': 1, '6960': 1, '7898': 1, '102978': 1, '12208': 1, '6944': 1, '101188': 1, '101265': 1, '102725': 1, '8291': 1, '102069': 1, '104080': 10, '103665': 3, '103849': 1, '103664': 5, '104124': 6, '104125': 2, '103365': 5, '103364': 5, '103362': 22, '103331': 33, '103189': 108, '103244': 1, '103363': 2, '103564': 9, '104424': 10, '103605': 1, '104197': 9, '12419': 1, '104251': 13, '101518': 1, '104381': 6, '9532': 1, '7793': 5, '104426': 70, '104425': 10, '101355': 1, '103662': 1, '103898': 3, '104035': 4, '102270': 14, '8275': 5, '104128':
            11, '104129': 1, '104395': 1, '104296': 1, '103544': 1, '104368': 1, '104369': 1}

ejemplo_dir = 'C:/Users/jhon_/Mi unidad/Scripts/Python/dynamic_light_scattering/Anka'
contenido = os.listdir(ejemplo_dir)
print(contenido)

code_err = []
product_err = []
message_err = []

name_new = ejemplo_dir + '/Procesado/' + 'template_format' + '.xlsx'
fichero_new = pd.ExcelWriter(name_new, engine='openpyxl')
error_xlsx = ejemplo_dir + '/Procesado/' + 'error' + '.xlsx'
# fichero_new = 0
file = 0

for fichero in contenido:
    if os.path.isfile(os.path.join(ejemplo_dir, fichero)) and fichero.endswith('.xlsx'):
        print(fichero)
        fich = os.path.join(ejemplo_dir, fichero)
        # print(fichero)

        xlsx = pd.ExcelFile(fich)
        sheet_names = xlsx.sheet_names

        # print(os.path.splitext(fichero)[0])

        # name_new = ejemplo_dir + '/Procesado/' + os.path.splitext(fichero)[0] + '.xlsx'
        # error_xlsx = ejemplo_dir + '/Procesado/' + 'error' + '.xlsx'
        # fichero_new = 0

        for sheet_name in sheet_names:

            data = pd.read_excel(fich, header=0,  sheet_name=sheet_name)
            z = data['SERIE'].fillna('')
            data = data.to_numpy()
            x = data[:, 0]
            lenght = len(x)
            k = sheet_name
            code = data[:, 1]
            y = data[:, 2]
            # z = data[:, 2]
            # print(z)
            z = np.array([str(i) for i in z if i != ''])
            z = list(z)
            sheet_name = str(k)
            if z and sheet_name in huancayo and lenght == huancayo.get(sheet_name, 0):
                # z = np.full(lenght, '')

                # fichero_new = pd.ExcelWriter(name_new, engine='openpyxl')
                tabla = pd.DataFrame(list(zip(x, code, y, z)), columns=[
                                     'ITEM', 'CODE', 'PRODUCT', 'SERIE'])
                tabla.to_excel(fichero_new, sheet_name=sheet_name, index=False)
                # print(y[0])

            else:
                # print(y[0])
                file = open(ejemplo_dir + '/Procesado/Errors' + '.txt', "a")
                file.write(y[0] + os.linesep)

                code_err.append(code[0])
                product_err.append(y[0])

                if not z:
                    message_err.append('No tiene serie')
                elif sheet_name not in huancayo:
                    message_err.append('No se encuentra en el stock inicial')
                elif lenght != huancayo.get(sheet_name, 0):
                    message = 'La cantidad no coincide: %s %s' % (
                        lenght, huancayo.get(sheet_name, 0))
                    message_err.append(message)
        print('FINISH')


# if fichero_new != 0:
    # fichero_new.save()

error = pd.ExcelWriter(error_xlsx, engine='openpyxl')
tabla_e = pd.DataFrame(list(zip(code_err, product_err, message_err)), columns=[
                       'CODE', 'PRODUCT', 'MESSAGE'])
tabla_e.to_excel(error, sheet_name='Errors', index=False)


if product_err:
    error.save()
if file != 0:
    file.close()
